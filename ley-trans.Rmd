---
title: "Data Analytics Ley Trans"
author: "Antonio Cabrera y √Ålvaro Sal√≠s"
date: "2024-05-15"
output:
  pdf_document: default
  html_document: default
---

## √çndice 

1. [Introducci√≥n](#introduction)
2. [Normalizaci√≥n de los datos](#normalizacion)
3. [Preprocesamiento de los datos](#preprocesamiento)
4. [Frecuencia de palabras](#frecuencia)
5. [An√°lisis de sentimientos](#sentimientos)
6. [An√°lisis de los tweets m√°s virales](#virales)
7. [An√°isis de #hashtags m√°s virales](#hashtags)
8. [Grafo de usuarios del dataset](#grafo)
9. [An√°lisis de comunidades](#comunidades)
10. [Conclusiones](#conclusiones)

### 1. Introducci√≥n <a name="introduccion"></a>

Popularmente conocida como la "Ley Trans", es uno de los proyectos m√°s controvertidos del gobierno de coalici√≥n de izquierda. Incluso dentro de la coalici√≥n hay opiniones opuestas. Si se aprueba el proyecto de ley, Espa√±a se convertir√≠a en el pa√≠s m√°s grande de Europa en permitir que las personas cambien legalmente el nombre y g√©nero en sus documentos de identidad sin la necesidad de a√±os de terapia hormonal o diagn√≥stico m√©dico. Esto ha provocado un gran debate y/o fuertes posicionamientos al respecto, lo que tambi√©n se ha reflejado en redes sociales como Twitter.

En este documento se van a analizar 14.1 millones de tweets del 13/01/2021 al 12/10/2022 en relaci√≥n a la [https://www.boe.es/buscar/doc.php?id=BOE-A-2023-5366](Ley trans). El dataset contiene m√°s de 14 millones de tweets, con 257.000 usuarios y 738.651 aristas (respuestas entre usuarios).

#### 1.1. Importar librer√≠as

```{r}
# Importaciones de las librerias que utilizaremos
library(quanteda)
library(quanteda.textplots)
library(stringr)
library(wordcloud2)
library(tm)
library(tidytext)
library(tidyverse)
library(syuzhet)
library(dplyr)
library(textdata)
library(ggplot2)
library(htmlwidgets)
library(igraph)
```

#### 1.2. Establecer el directorio de trabajo

```{r}
# Establecer directorio de trabajo
setwd("/home/antonio/Repos/ley-trans")
```

#### 1.3. Cargar el dataset

El dataset es de Kaggle y se puede encontrar en el siguiente enlace: https://www.kaggle.com/datasets/hectorfr1984/spanish-trans-law-twitter-dataset

```{r}
df <- data.frame()
dataset_csv <- read.csv("spanish-trans-law-twitter-dataset.csv", header = TRUE, sep = ",", fill = TRUE)
df <- rbind(dataset_csv, df)
```

Guardamos el dataset en un archivo rda para poder trabajar con √©l m√°s adelante.

```{r}
# Guardamos el data frame en un archivo rda
save(df, file = "df.rda")
```

### 2. Normalizaci√≥n de los datos <a name="normalizacion"></a>

El dataset no est√° normalizado, ya que en cada fila tenemos informaci√≥n de los usuarios la cual deber√≠a estar en una tabla aparte, por lo tanto vamos a separar el dataframe en dos dataframes de usuarios y tweets.

#### 2.1. Daframe de usuarios

El dataframe de usuarios tendr√° los siguientes campos: `user_id`, `user_screen_name`, `user_description`, `user_created_at_iso`, `user_followers` y `user_friends`.

```{r}
df_usuarios <- df %>% 
  select(user_id, user_screen_name, user_description, user_created_at_iso, user_followers, user_friends) %>% 
  distinct()
```

Los followers y friends van variando en funci√≥n del tiempo, por lo tanto para no tener filas repetidas, usaremos el m√°ximo de followers y friends de cada usuario.

```{r}
df_usuarios <- df_usuarios %>%
  group_by(user_id) %>%
  summarise(user_screen_name = first(user_screen_name),
            user_description = first(user_description),
            user_created_at_iso = first(user_created_at_iso),
            user_followers = max(user_followers),
            user_friends = max(user_friends))
```

Tambi√©n normalizaremos la fecha de creaci√≥n de los usuarios.

```{r}
df_usuarios$user_created_at_iso <- as.POSIXct(df_usuarios$user_created_at_iso, format="%Y-%m-%d")
```

Guardamos el dataframe de usuarios en un archivo rda.

```{r}
# Guardamos el data frame en un archivo rda
save(df_usuarios, file = "df_usuarios.rda")
```

El dataframe de usuarios tendr√° los siguientes campos: `tweet_id`, `in_reply_to_user_id`, `user_id`, `retweet_id`, `retweet_user_id`, `tweet_created_at_iso`, `tweet_full_text`.

```{r}
df_tweets <- df %>% 
  select(tweet_id, in_reply_to_user_id, user_id, retweet_id, retweet_user_id, tweet_created_at_iso, tweet_full_text) %>% 
  distinct()
```

Guardamos el dataframe de tweets en un archivo rda.

```{r}
# Guardamos el data frame en un archivo rda
save(df_tweets, file = "df_tweets.rda")
```

### 3. Preprocesamiento de los datos <a name="preprocesamiento"></a>

Crearemos un nuevo dataframe `df_filtered` con el contenido de los tweets filtrado.

```{r}
df_filtered <- df_tweets
```

#### 3.1. Normalizar las fechas

Para poder trabajar con las fechas, vamos a convertirlas a formato POSIXct

```{r}
df_filtered$tweet_created_at_iso <- as.POSIXct(df_filtered$tweet_created_at_iso, format="%Y-%m-%d")
```

#### 3.2. Pasar los tweets a min√∫sculas

Es necesario pasar los tweets a min√∫sculas para evitar que palabras iguales pero escritas de forma diferente se consideren diferentes.

```{r}
#Convertimos todas las letras a min√∫sculas
df_filtered$tweet_full_text <- tolower(df_filtered$tweet_full_text)
```

#### 3.3. Eliminar stopwords

Las stopwords son palabras que no aportan significado al texto, como art√≠culos, preposiciones, etc. Vamos a eliminarlas de los tweets.

```{r}
# Eliminar las stopwords del espa√±ol
df_filtered$tweet_full_text <- removeWords(df_filtered$tweet_full_text, stopwords("es"))
```

Se ha observado que es muy popular en los tweets el uso de stopwords acortadas, como "q" en lugar de "que", "x" en lugar de "por", etc. Por lo tanto, eliminaremos las palabras de una sola letra.

```{r}
# Eliminar las palabras de una sola letra
df_filtered$tweet_full_text <- str_replace_all(df_filtered$tweet_full_text, "\\b[a-zA-Z]\\b", "")
```

#### 3.4. Eliminar URLs, n√∫meros, caracteres especiales y palabras no deseadas

Eliminamos las URLs de los tweets.

```{r}
# Eliminar urls
df_filtered$tweet_full_text <- str_replace_all(df_filtered$tweet_full_text, "https?://([^/\\s]++)\\S*+|http?://([^/\\s]++)\\S*+", "")
```

Eliminamos los n√∫meros y los caracteres especiales.

```{r}
# Eliminar los n√∫meros y los car√°cteres especiales
df_filtered$tweet_full_text <- str_replace_all(df_filtered$tweet_full_text, "[^[:alpha:][:space:]]", "")
```

Por √∫ltimo eliminamos las palabras que no sean de nuestro inter√©s. Las palabras "ley" y "trans" son redundantes ya que todos los tweets van en relaci√≥n a ese mismo tema. La palabra "si" es muy com√∫n en los tweets y no aporta informaci√≥n relevante, y "rt" es la abreviatura de "retweet".

```{r}
# Eliminar palabras que no sean de nuestro inter√©s
palabras_eliminar = c("ley", "trans", "leytrans", "rt", "si")
df_filtered$tweet_full_text <- removeWords(df_filtered$tweet_full_text, palabras_eliminar)
```

#### 3.5. Eliminar hashtags, menciones y retweets

```{r}
# Eliminar los hashtags, menciones y retweets
df_filtered$tweet_full_text <- str_replace_all(df_filtered$tweet_full_text, "#\\S+", "")
df_filtered$tweet_full_text <- str_replace_all(df_filtered$tweet_full_text, "@\\S+", "")
df_filtered <- df_filtered[!grepl("^RT", df_filtered$tweet_full_text),]
```

#### 3.6. Guardar el dataset filtrado

```{r}
# Guardamos el data frame en un archivo r### 4. Frecuencia de palabras <a name="frecuencia"></a>da
save(df_filtered, file = "df_filtered.rda")
```

### 4. Frecuencia de palabras <a name="frecuencia"></a>

#### 4.1. Crear matriz de frecuencia de palabras

##### 4.1.1. Crear corpus y tokens
 
Creamos el corpus de los tweets, que como ya se ha mencionado, es un conjunto de documentos de texto.

```{r}
# Crear un corpus con los tweets
corpus_tweets <- corpus(df_filtered$tweet_full_text)
```

Creamos los tokens, que son las palabras que componen los documentoss. Indicamos que queremos eliminar los n√∫meros, los signos de puntuaci√≥n, los s√≠mbolos, los separadores y las URLs. 

```{r}
# Generamos los tokens
token_tweets <-quanteda::tokens(corpus_tweets,
                              what = "word",
                              remove_numbers = TRUE,
                              remove_punct = TRUE,
                              remove_symbols = TRUE,
                              remove_separators = TRUE,
                              remove_url = TRUE)
```

##### 4.1.2. Crear matriz de frecuencia

```{r}
# Generamos la matriz de frecuencia de los tweets
matrix_tweets <-dfm(token_tweets)
```

#### 4.2. Barplot de las 10 palabras m√°s frecuentes

Primero sacamos las 10 palabras m√°s frecuentes con la ayuda de nuestra matriz de frecuencia.

```{r}
# Mostramos las 10 palabras m√°s frecuentes
top_10 <- topfeatures(matrix_tweets, 10)
top_10
```

Pasamos el objeto `top_10` a un data frame para poder hacer el gr√°fico.

```{r}
# Convertimos el objeto top_10 a un data frame
top_10_df <- data.frame(palabra = names(top_10), frecuencia = as.numeric(top_10))
```

Creamos el gr√°fico de barras con las 10 palabras m√°s frecuentes.

```{r}
# Barplot
barplt <- ggplot(top_10_df, aes(x = reorder(palabra, frecuencia), y = frecuencia)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  coord_flip() +
  theme_minimal() +
  labs(
       x = "Palabra",
       y = "Frecuencia")

barplt
```

Por √∫ltimo, guardamos el gr√°fico de barras.

```{r}
# Guardamos el gr√°fico
ggsave("barplot.png", plot = barplt, width = 10, height = 5, units = "in")
```

#### 4.3. Wordcloud de las palabras m√°s frecuentes

##### 4.3.1 Wordcloud normal

En este caso sacaremos las 100 palabras m√°s frecuentes y las pasamos a data frame.

```{r}
# Hacemos el dataframe del top 100
top_100 <- topfeatures(matrix_tweets, 100)
top_100_df <- data.frame(palabra = names(top_100), frecuencia = as.numeric(top_100))
```

Creamos el wordcloud con las 100 palabras m√°s frecuentes. Ajustamos los parametros `minRotation` y `maxRotation` y `rotateRatio` para darle un aspecto m√°s atractivo.

```{r}
# Wordcloud
worldcloud_palabras <- wordcloud2(top_100_df, size = 1.0 , minRotation = -pi/6, maxRotation = -pi/6, rotateRatio = 1)
worldcloud_palabras
```

En el wordcloud la palabra m√°s predominante es personas, ya que se usa mucho "personas trans"; lo mismo pasa con mujeres ("mujeres trans"). Tambi√©n podemos encontrar los 4 p√°rtidos pol√≠ticos m√°s importantes de Espa√±a: PSOE, PP, Vox y Podemos. Destaca tambi√©n la palabra "menores" que va en relaci√≥n a las cr√≠ticas de la ley por parte de los detractores. Otras palabras en relaci√≥n al tema son g√©nero, sexo y lgtpi.

Guardamos el wordcloud. Solo se guardar√° el html, ya que el wordcloud2 no se puede guardar en formato png.

```{r}
# Guardar el wordcloud
htmlwidgets::saveWidget(worldcloud_palabras, "wordcloud_palabras.html", selfcontained = TRUE)
```

##### 4.3.2 Wordcloud de bigramas

Generamos los bigramas.

```{r}
# Generamos los bigramas
bigramas <- tokens_ngrams(token_tweets, n = 2)
```

Creamos la matriz de frecuencia de los bigramas.

```{r}
# Generamos la matriz de frecuencia de los bigramas
matrix_bigramas <- dfm(bigramas)
```

Sacamos las 100 palabras m√°s frecuentes de los bigramas.

```{r}
top_100 <- topfeatures(matrix_bigramas, 100)
top_100_df <- data.frame(palabra = names(top_100), frecuencia = as.numeric(top_100))
```

Creamos el wordcloud de los bigramas.

```{r}
# Wordcloud
worldcloud_palabras_bigramas <- wordcloud2(top_100_df, size = 1.0 , minRotation = -pi/6, maxRotation = -pi/6, rotateRatio = 1)
```

![wordcloud_bigramas](wordcloud-bigramas.png)
En el caso de los bigramas figuras pol√≠ticas como Irene Montero (ex-ministra de igualdad) y Carmen Calvo (actual presidenta del Consejo de Estado). Otras palabras en relaci√≥n al tema son "identidad genero", "autodeterminaci√≥n genero" y "derechos personas". En general aparecen muchos bigramas con la palabra derechos, lo cual puede indicar que la ley se ve como un avance en los derechos de las personas.

Lo guardamos.

```{r}
# Guardar el wordcloud
htmlwidgets::saveWidget(worldcloud_palabras_bigramas, "wordcloud_bigramas.html", selfcontained = TRUE)
```

### 5. An√°lisis de sentimientos <a name="sentimientos"></a>

El an√°lisis de sentimientos es una t√©cnica que consiste en determinar si un texto es positivo, negativo o neutro. Para ello, se asigna un valor num√©rico a cada palabra del texto mediante un diccionario sentimental. En nuestro caso, al ser un dataset en espa√±ol, no existen muchos diccionarios sentimentales, por lo que utilizaremos la funci√≥n `get_sentiment` del paquete `syuzhet`, la cual primero traduce la palabra al ingl√©s y luego le asigna un valor sentimental.

#### 5.1. Crear diccionario sentimental

Primero creamos un tidyset con los tweets.

```{r}
# Creamos un tidyset con los tweets
tidy <- df_filtered %>% 
  unnest_tokens(word, tweet_full_text)
```

Para ahorrarnos tiempo de computo, vamos a generar un diccionario sentimental con todas las palabras del dataset.

```{r}
# Creamos un diccionario sentimental con todas las palabras del dataset usando la funci√≥n get_sentiment(word, method = "nrc", lang="spanish")
sentiment_dict <- tidy %>%
  distinct(word) %>%
  mutate(sentiment = get_sentiment(word, method = "nrc", lang="spanish"))
```

Agregaremos algunas palabras customizadas que el diccionario sentimental no ha detectado.

```{r}
palabras_a√±adir = c("facha","nazi","racista",
                    "racistas","nazis","gilipollas",
                    "sanchista","sanchistas","maricones",
                    "alertafeminista","fachas","vertederofacha",
                    "neonazis","neonazi","feminazis",
                    "terfisfeminazi","transfobo","machista",
                    "machismo","sexta","transfobia",
                    "terf","terfs","terfas",
                    "retrograda","transexcluyente","transexcluyentes",
                    "feminazi","fachasnazis","maricas",
                    "machirulo","perro","derrogaci√≥n",
                    "dictador","franco","fascista",
                    "progre","retroceso","podemita",
                    "podemitas","retrogrado","hom√≥fobo",
                    "hom√≥fobos","hom√≥fobas","homofobia",
                    "rojo", "rojos","puto",
                    "putos", "bulo","bulos",
                    "comunista","comunistas","violador",
                    "violadores","patriarcado","patriarcal",
                    "maric√≥n","comunismo","socialcomunista",
                    "pitorreo","terfachas","travelo")

# Si la palabra ya est√° recogida, cambiamos su valor sentimental a -3
new_sentiment_dict <- sentiment_dict %>%
  mutate(sentiment = ifelse(word %in% palabras_a√±adir, -3, sentiment))

# Si la palabra no est√° recogida, la a√±adimos con valor sentimental -3
new_sentiment_dict <- new_sentiment_dict %>%
  anti_join(data.frame(word = palabras_a√±adir), by = "word") %>%
  bind_rows(data.frame(word = palabras_a√±adir, sentiment = -3))
```

#### 5.2. Calcular sentimiento de los tweets

Una vez tenemos el diccionario sentimental, calculamos el sentimiento de cada tweet.

```{r}
# Ahora a cada tweet le a√±adimos el sentimiento
tweets_sentiment <- tidy %>%
  inner_join(new_sentiment_dict, by = "word") %>%
  group_by(tweet_id) %>%
  summarise(sentiment = sum(sentiment))
```

#### 5.3. Histograma de la cantidad de tweets por sentimiento

Mostramos el histograma de los sentimientos.

```{r}
ggplot(data = tweets_sentiment, aes(x = sentiment)) + 
  geom_bar(color = 'darkslategray', fill = 'steelblue') + 
  xlab("Sentimiento") + 
  ylab("Cantidad de Tweets") + 
  ggtitle("Gr√°fico sentimiento")

# Guardamos el gr√°fico
ggsave("sentiment.png", plot = last_plot(), width = 10, height = 5, units = "in")
```

Por √∫ltimo, calculamos el porcentaje de tweets positivos, negativos y neutros.

```{r}
# Calcular porcentaje de tweets positivos, negativos y neutros
tweets_sentiment %>%
  summarise(
    positivos = sum(sentiment > 0) / n() * 100,
    negativos = sum(sentiment < 0) / n() * 100,
    neutros = sum(sentiment == 0) / n() * 100
  )
```

Vemos que en general los tres tipos de sentimientos est√°n bastante equilibrados, aunque predominan los neutros y entre los positivos y negativos ganan los positivos. Que haya m√°s sentimiento positivo en relaci√≥n a la ley puede indicar que en general hay mas apoyo que detractores de la ley.

#### 5.4. Gr√°fico de sentimiento en el tiempo

Generaremos el gr√°fico del sentimiento en el tiempo con ambos diccionarios para comprobar si las palabras a√±adidas han afectado al sentimiento de los tweets.

##### 5.4.1. Gr√°fico de sentimiento en el tiempo con diccionario modificado

Primero, creamos un dataframe con la fecha y el sentimiento de cada tweet.

```{r}
# Creamos un dataframe con la fecha y el sentimiento de cada tweet
df_sentimiento <- df_filtered %>%
  inner_join(tweets_sentiment, by = "tweet_id") %>%
  select(tweet_created_at_iso, sentiment)
```

Creamos un gr√°fico de sentimiento en el tiempo.

```{r}
# Gr√°fico de sentimiento en el tiempo
ggplot(data = df_sentimiento,
       aes(x = tweet_created_at_iso,
           y = sentiment
          )) + 
  geom_smooth(color = 'darkslategray') + 
  xlab("Fecha") + 
  ylab("Sentimiento") + 
  scale_x_datetime(date_labels = "%b", date_breaks = "1 month") +
  ggtitle("Gr√°fico de sentimiento en el tiempo")
```

El 10 de marzo de 2021 comenzo la huelga de hambre de Mar Cambrolle la cual ya ha sido mencionada en el an√°lisis de hashtags. A partir de esa fecha, el sentimiento positivo a ido creciendo. El 17 de marzo de ese mismo a√±o se registr√≥ la *Proposici√≥n de Ley para la igualdad real y efectiva de las personas trans* en el Congreso de los Diputados, lo que puede haber influido en el sentimiento positivo. El 18 de mayo se vot√≥ por la admisi√≥n de la ley, la cual fue rechazada debido a los votos de PP, Vox y por la abstenci√≥n del PSOE.

El 29 de junio de 2021, el ministerio de igualdad present√≥ el anteproyecto de ley, en el que se inclu√≠a la autodeterminaci√≥n de g√©nero para mayores de 16 a√±os, y la eliminaci√≥n de la necesidad de diagn√≥stico m√©dico para cambiar el g√©nero en el DNI. A partir de la presentaci√≥n del anteproyecto, se observa un m√≠nimo que por primera vez es negativo en el gr√°fico. Puede deverse a que cuando ses present√≥ el anteproyecto, se incluyeron medidas que no gustaron a los detractores de la ley.

En junio de 2022 se observa un gran pico de positividad, se puede deber a que el 27 de junio de 2022 el documento de anteproyecto fue aprobado, pasando a ser un proyecto de ley. Luego, vemos un gran descenso en la positividad, que puede deberse a la perdida del gran inter√©s inicial de la izquierda y a las cr√≠ticas de los retractores.

El 8 de septiembre se anunci√≥ que se reducir√≠an la mitad de los plazos de la ley, lo cual har√≠a que se aprobase ante la ley. Justo en este periodo comienza a subir la positividad, lo cual puede deberse a que la ley finalmente se aprobar√°.

##### 5.4.2. Gr√°fico de sentimiento en el tiempo con diccionario sin modificar

Si lo comparemos con el gr√°fico generado usando el diccionario sin modificar, vemos que las palabras customizadas han afectado notablemente al sentimiento de los tweets.

```{r}
tweets_sentiment_old <- tidy %>%
  inner_join(sentiment_dict, by = "word") %>%
  group_by(tweet_id) %>%
  summarise(sentiment = sum(sentiment))

df_sentimiento_old <- df_filtered %>%
  inner_join(tweets_sentiment_old, by = "tweet_id") %>%
  select(tweet_created_at_iso, sentiment)

ggplot(data = df_sentimiento_old,
       aes(x = tweet_created_at_iso,
           y = sentiment
          )) + 
  geom_smooth(color = 'darkslategray') + 
  xlab("Fecha") + 
  ylab("Sentimiento") + 
  scale_x_datetime(date_labels = "%b", date_breaks = "1 month") +
  ggtitle("Gr√°fico de sentimiento en el tiempo")
```

### 6. An√°lisis de los tweets m√°s virales <a name="virales"></a>

Primero sacaremos los tweets m√°s virales, es decir, los tweets con m√°s respuestas. Para ello agruparemos los tweets por la columna `in_reply_to_user_id`, que indica el id del tweet al que se responde, y contaremos cu√°ntas respuestas tiene cada tweet.

```{r}
tweets_virales <- df_tweets %>%
  group_by(retweet_id) %>%
  summarise(retweets = n()) %>%
  arrange(desc(retweets))
```

El tweet m√°s viral saldra como `NA` ya que la mayor√≠a te tweets no son en respuesta a otros, por lo tanto eliminaremos ese tweet.

```{r}
tweets_virales <- tweets_virales[-1,]
tweets_virales
```

Crearemos una funci√≥n para ver el n-√©simo tweet m√°s viral.

```{r}
ver_tweet_viral <- function(n) {
  tweet_viral_id <- tweets_virales$retweet_id[n]
  tweet <- subset(df_tweets, tweet_id == tweet_viral_id)
  user <- subset(df_usuarios, user_id == tweet$user_id)
  
# Mostramos la informaci√≥n del tweet
cat(sprintf("Retweets: %d\nUsuario: %s\nDescripci√≥n:%s\nContenido:%s",
            tweets_virales$retweets[n], user$user_screen_name,
            user$user_description, tweet$tweet_full_text))
}
```

El tweet con mayor n√∫mero de retweets (5119) es a favor de la ley, y es del presidente de M√°s Madrid, `@EduardoFRub`. El n√∫mero de retweets puede parecer bajo, pero esto se debe a que el dataset no recoge todos los retweets de cada tweet.

```{r}
ver_tweet_viral(1)
```

El segundo tweet m√°s viral (4835), va en contra de la ley y es de una usuaria canaria con 3641 followers. En el tweet, se queja de que la comunidad de canarias haya aprobado la ley.

```{r}
ver_tweet_viral(2)
```

El tercer tweet m√°s viral, es de  Irene Montero, ex ministra de Igualdad. Se trata de un hilo desmintiendo bulos de la ley trans.

```{r}
ver_tweet_viral(3)
```


### 7. An√°isis de #hashtags m√°s virales <a name="hashtags"></a>

Los hashtags son una forma de categorizar los tweets y de hacer que estos sean m√°s visibles. Nos pueden ayudar a conocer los temas m√°s populares sobre la ley.

Sacamos los hashtags m√°s virales.

```{r}
hashtags_virales <- df_tweets %>%
  filter(str_detect(tweet_full_text, "#")) %>%
  mutate(hashtags = str_extract_all(tweet_full_text, "#\\w+")) %>%
  unnest(hashtags) %>%
  group_by(hashtags) %>%
  summarise(tweets = n()) %>%
  arrange(desc(tweets))
```

Visualizamos los hashtags m√°s virales.

```{r}
hashtags_virales
```

#### 7.1. An√°lisis del hashtag #HuelgaDeHambreTrans

El primer hastag interesante es el de `#HuelgaDeHambreTrans`, veamos de que trata este sentimiento.

Sacamos tweets con el hashtag `#HuelgaDeHambreTrans`.

```{r}
df_tweets_huelga <- df_tweets %>%
  filter(str_detect(tweet_full_text, "#HuelgaDeHambreTrans"))

# A√±adimos el n√∫mero de retweets a los tweets
df_tweets_huelga <- tweets_virales %>%
  inner_join(df_tweets_huelga, by = c("retweet_id" = "tweet_id"))

# Los ordenamos por n√∫mero de retweets
df_tweets_huelga <- df_tweets_huelga[order(-df_tweets_huelga$retweets),]
```

Para ver los tweets definiremos una funci√≥n r√°pido para ver tweets.

```{r}
ver_tweet <- function(n) {
  tweet <- df_tweets_huelga[n,]
  user <- subset(df_usuarios, user_id == tweet$user_id)
  
  # Mostramos la informaci√≥n del tweet
  cat(sprintf("Usuario: %s\nDescripci√≥n:%s\nContenido:%s\nRetweets: %i", user$user_screen_name, user$user_description, tweet$tweet_full_text, tweet$retweets))
}
```

Leeamos un tweet cualquiera con el hashtag `#HuelgaDeHambreTrans`.

El primer tweet no va en relaci√≥n a la huelga, es de una mujer trans que comenta como el partido feminista ha convocado un encuentro anti trans. El grupo de feministas en contra de las personas trans es conocido como TERF, pero en espa√±ol se utiliza m√°s el termino peroyativo "terfas". Estas feministas consideran que las mujeres trans, al haber nacido hombres, no pueden ser consideradas mujeres y que son "hombres infiltrados".

```{r}
ver_tweet(1)
```

El segundo tweet m√°s viral de `#HuelgaDeHambreTrans` explica que la huelga trans se debe al bloqueo de la ley impuesto por el PSOE.

```{r}
ver_tweet(2)
```

Veamos el √∫ltimo tweet en relaci√≥n al hashtag `#HuelgaDeHambreTrans`. La activista trans Mar Cambrolle, cuenta que la huelga ser√° de 3 d√≠as y que se quieren conseguir reconocer un derecho humano.

```{r}
ver_tweet(4)
```

#### 7.2. An√°lisis del hashtag #LeyTransYa

Ahora veamos uno de los hashtags a favor de la ley, `#LeyTransYa`.

Sacamos tweets con el hashtag `#LeyTransYa`.

```{r}
df_tweets_ley <- df_tweets %>%
  filter(str_detect(tweet_full_text, "#LeyTransYa"))

# A√±adimos el n√∫mero de retweets a los tweets
df_tweets_ley <- tweets_virales %>%
  inner_join(df_tweets_ley, by = c("retweet_id" = "tweet_id"))

# Los ordenamos por n√∫mero de retweets
df_tweets_ley <- df_tweets_ley[order(-df_tweets_ley$retweets),]

ver_tweet_ley <- function(n) {
  tweet <- df_tweets_ley[n,]
  user <- subset(df_usuarios, user_id == tweet$user_id)
  
  # Mostramos la informaci√≥n del tweet
  cat(sprintf("Usuario: %s\nDescripci√≥n:%s\nContenido:%s\nRetweets:%s",
   user$user_screen_name, user$user_description, tweet$tweet_full_text, tweet$retweets))
}
```

El primer tweet es conciso y directo, es de un usuario que pide la aprobaci√≥n de la ley.

```{r}
ver_tweet_ley(1)
```

El siguiente tweet tiene un tono m√°s agresivo (Stay angry, #AngryTransYouth) y da animos al colectivo a 'cambiar las cosas'.

```{r}
ver_tweet_ley(2)
```

El √∫ltimo tweet que veremos es de un usuario que celebra la aprobaci√≥n del dict√°men de la ley.

```{r}
ver_tweet_ley(3)
```

#### 7.3. An√°lisis del hashtag #NoLeyTrans

Los 13 primeros #hastags vemos que son a favor de la ley, uno de los primeros negativos es `#NoLeyTrans`, veamos algunas de las opiniones en contra de la ley.

Sacamos tweets con el hashtag `#NoLeyTrans`.

```{r}
df_tweets_no_ley <- df_tweets %>%
  filter(str_detect(tweet_full_text, "#NoLeyTrans"))

# A√±adimos el n√∫mero de retweets a los tweets
df_tweets_no_ley <- tweets_virales %>%
  inner_join(df_tweets_no_ley, by = c("retweet_id" = "tweet_id"))

# Los ordenamos por n√∫mero de retweets
df_tweets_no_ley <- df_tweets_no_ley[order(-df_tweets_no_ley$retweets),]

ver_tweet_no_ley <- function(n) {
  tweet <- df_tweets_no_ley[n,]
  user <- subset(df_usuarios, user_id == tweet$user_id)
  
# Mostramos la informaci√≥n del tweet
cat(sprintf("Usuario: %s\nDescripci√≥n:%s\nContenido:%s\nRetweets:%d",
 user$user_screen_name, user$user_description, tweet$tweet_full_text, tweet$retweets))
}
```

Veamos un tweet en contra de la ley.

El primer tweet parace ser de otra feminista TERF, que habla de como se les va a 'lava el cerebro a las ni√±as para que se crean chicos'.

```{r}
ver_tweet_no_ley(1)
```

El segundo tweet con m√°s retweets es de un usuario que odia a la izquierda. El tweet incita a la gente a popularizar el hashtag `#NoLeyTrans` para manifestar el rechazo a la ley.

```{r}
ver_tweet_no_ley(2)
```

El tercer tweet es de ConfluenciaMF, una organizaci√≥n feminista TERF, que cuenta como una compa√±era de la organizaci√≥n hablar√° en la 1 sobre 'el disparate' de la ley.

```{r}
ver_tweet_no_ley(3)
```

Cabe destacar que los tweets del hashtag `#NoLeyTrans` tienen muchos menos retweets que los dos otros hastags a favor.

#### 7.4. Conclusiones de los hashtags

Hemos visto que los hashtags a favor de la ley tienen m√°s retweets que los hashtags en contra. Esto puede indicar que la ley tiene m√°s apoyo que detractores. Adem√°s, aunque en un principio pudiese parecer que los detractores de la ley fuesen en su mayor√≠a votantes de derechas, parece que la mayor√≠a es el colectivo feminista TERF.

### 8. Grafo de usuarios del dataset <a name="grafo"></a>

#### 8.1. Grafo de interacciones entre usuarios

Nuestro dataset no contiene la id de los tweets de respuesta, pero si la de los usuarios a los que se responde. Por lo tanto, crearemos un grafo de interacciones entre usuarios.

Primero, creamos un data frame con las columnas `user_id` y `in_reply_to_user_id`.

```{r}
df_interacciones <- df_filtered %>%
  select(user_id, in_reply_to_user_id) %>%
  na.omit()
```

Creamos el grafo de interacciones.

```{r}
grafo <- graph_from_data_frame(df_interacciones, directed = TRUE)
```

Crearemos una funci√≥n para ver los usuarios con m√°s interacciones.

```{r}
# Sacamos el usuario con m√°s interaccionesmarx
usuarios_interacciones <- degree(grafo, mode = "in")

# Creamos un data frame con los usuarios y sus interacciones
df_usuarios_interacciones_id <- data.frame(
  user_id = as.numeric(names(usuarios_interacciones)),
  interacciones = as.numeric(usuarios_interacciones))

df_usuarios_interacciones_id <- df_usuarios_interacciones_id[order(-df_usuarios_interacciones_id$interacciones),]

# Al dataframe le a√±adimos una columna con el nombre de usuario
df_usuarios_interacciones <- df_usuarios_interacciones_id %>%
  inner_join(df_usuarios, by = "user_id")

# Seleccionamos solo las columnas del nombre y las interacciones
df_usuarios_interacciones <- df_usuarios_interacciones %>%
  select(user_screen_name, interacciones)

head(df_usuarios_interacciones, 10)
```

Vemos que los 5 usuarios m√°s relevantes son pol√≠ticos de izquierdas, lo que puede indicar que la izquierda habla m√°s del tema que la derecha.

#### 8.2. Usuarios con m√°s seguidores

Creamos un data frame con los usuarios y sus seguidores.

```{r}
df_usuarios_seguidores <- df_usuarios %>%
  select(user_id, user_screen_name, user_followers) %>%
  arrange(desc(user_followers))

df_usuarios_seguidores
```

Mucho de las cuentas con m√°s seguidores son cuentas de medios de comunicaci√≥n. Aunque se√°n los usuarios con m√°s seguidores, vemos que no son los usuarios con m√°s interacciones.


### 9. An√°lisis de comunidades <a name="comunidades"></a>

Debido al tama√±o y la complejidad del dataset, hemos decidido centrarnos en comunidades peque√±as pero de las cuales tenemos la certeza de que est√°n a favor o en contra de la ley.

#### 9.1. Generar comunidades

Al intentar analizar las comunidades mediante un algoritmo como el de Louvain, los resultados no son los esperados. Por lo tanto, utilizaremos un m√©todo m√°s simple, que consiste en agrupar los usuarios por el contenido de su biograf√≠a.

Observando a los usuarios, vimos que es bastante com√∫n poner banderas en la descripci√≥n de los perfiles. Estas banderas, aunque no siempre tienen que ver con la opini√≥n sobre la ley, nos sirven como punto de partida para agrupar a los usuarios.

##### 9.1.1. Usuarios a favor

Primero, sacamos los usuarios que tienen en su descripci√≥n la bandera trans. Hemos asumido que los usuarios que tienen la bandera trans en su descripci√≥n est√°n a favor de la ley.

Obtenemos una comunidad de 722 usuarios.

```{r}
df_usuarios_favor <- df_usuarios %>%
  filter(str_detect(user_description, "üè≥Ô∏è‚Äç‚ößÔ∏è"))
df_usuarios_favor
```

El siguiente paso ser√° recoger todos los tweets de los usuarios a favor de la ley.

```{r}
df_tweets_favor <- df_filtered %>%
  inner_join(df_usuarios_favor, by = "user_id")
```

##### 9.1.2. Usuarios de vox

Sacaremos los usuarios que tengan en su descripci√≥n la palabra "vox". 

En este caso tenemos una comunidad de 369 usuarios, aproximadamente la mitad que la comunidad a favor (esto no significa que haya, en general, la mitad de usuarios en contra que a favor).

```{r}
df_usuarios_vox <- df_usuarios %>%
  filter(str_detect(user_description, "vox"))
df_usuarios_vox
```

Sacamos los tweets de los usuarios en contra de la ley.

```{r}
df_tweets_vox <- df_filtered %>%
  inner_join(df_usuarios_vox, by = "user_id")
```

##### 9.1.3. Usuarias TERFs

Como hemos visto antes, las feministas TERFs son las que mayor oposici√≥n muestran a la ley. Ya hemos comentado antes que el termino TERF se usa de forma despectiva, hemos observado que las feministas terfs suelen denominarse as√≠ mismas como "radfem" (abreviatura de radical feminist), as√≠ que sacaremos a las usuarias que tengan en su descripci√≥n la palabra "radfem".

```{r}
df_usuarios_terf <- df_usuarios %>%
  filter(str_detect(user_description, "radfem"))
df_usuarios_terf
```

Sacamos los tweets de las usuarias TERFs.

```{r}
df_tweets_terf <- df_filtered %>%
  inner_join(df_usuarios_terf, by = "user_id")
```

#### 9.2. Palabras m√°s frecuentes en cada comunidad

Para ver si efectivamente hemos agrupado a los usuarios correctamente, vamos a sacar las palabras m√°s frecuentes en cada comunidad.

##### 9.2.1. Palabras m√°s frecuentes en la comunidad a favor

Primero, sacamos las palabras m√°s frecuentes en la comunidad a favor de la ley.

```{r}
# Creamos un corpus con los tweets
corpus_tweets_favor <- corpus(df_tweets_favor$tweet_full_text)

# Generamos los tokens
token_tweets_favor <-quanteda::tokens(corpus_tweets_favor,
                              what = "word",
                              remove_numbers = TRUE,
                              remove_punct = TRUE,
                              remove_symbols = TRUE,
                              remove_separators = TRUE,
                              remove_url = TRUE)
```

Creamos la matriz de frecuencia de las palabras.

```{r}
# Generamos los bigramas
bigramas_favor <- tokens_ngrams(token_tweets_favor, n = 2)

# Generamos la matriz de frecuencia de los tweets
matrix_tweets_favor <-dfm(bigramas_favor)

# Vemos las 10 palabras m√°s frecuentes
top_10 <- topfeatures(matrix_tweets_favor, 10)
top_10
```

En la comunidad a favor de la ley aparecen bigramas como "identidad_g√©nero", "derechos_personas", "derechos_humanos" y "derechos_lgtbi" que reflejan una opini√≥n positiva sobre la ley.

##### 9.2.2. Palabras m√°s frecuentes en la comunidad de usuarios de vox

Ahora sacamos las palabras m√°s frecuentes en la comunidad de usuarios de vox.

```{r}
# Creamos un corpus con los tweets
corpus_tweets_vox <- corpus(df_tweets_vox$tweet_full_text)

# Generamos los tokens
token_tweets_vox <-quanteda::tokens(corpus_tweets_vox,
                              what = "word",
                              remove_numbers = TRUE,
                              remove_punct = TRUE,
                              remove_symbols = TRUE,
                              remove_separators = TRUE,
                              remove_url = TRUE)

# Generamos los bigramas
bigramas_vox <- tokens_ngrams(token_tweets_vox, n = 2)

# Generamos la matriz de frecuencia de los tweets
matrix_tweets_vox <-dfm(bigramas_vox)

# Generamos el wordcloud
top_10_vox <- topfeatures(matrix_tweets_vox, 10)
top_10_vox
```

En la comunidad de los usuarios de vox aparecen bigramas como "amenaza_mujeres", "derechos_distop√≠a", "distop√≠a_sanchista" que reflejan una opini√≥n negativa sobre la ley.

##### 9.2.3. Palabras m√°s frecuentes en la comunidad de usuarias TERFs

Por √∫ltimo, sacamos las palabras m√°s frecuentes en la comunidad de usuarias TERFs.

```{r}
# Creamos un corpus con los tweets
corpus_tweets_terf <- corpus(df_tweets_terf$tweet_full_text)

# Generamos los tokens
token_tweets_terf <-quanteda::tokens(corpus_tweets_terf,
                              what = "word",
                              remove_numbers = TRUE,
                              remove_punct = TRUE,
                              remove_symbols = TRUE,
                              remove_separators = TRUE,
                              remove_url = TRUE)

# Generamos los bigramas
bigramas_terf <- tokens_ngrams(token_tweets_terf, n = 2)

# Generamos la matriz de frecuencia de los tweets
matrix_tweets_terf <-dfm(bigramas_terf)

# Generamos el top 10
top_10_terf <- topfeatures(matrix_tweets_terf, 10)
top_10_terf
```

La frase "mal llamada", se usa en muchos tweets en los que se critica la ley ("la mal llamada ley trans..."), lo mismo que "ser mujer" que son tweets en los que dicen "Quiero ser mujer, es mi derecho como hombre". Por lo tanto se ve que las usuarias TERFs, adem√°s de hablar del feminismo y de la violencia de g√©nero, tambi√©n est√°n en contra de la ley.

#### 9.3. Grafo de interacciones de las comunidades

Generaremos un grafo en el que los nodos verdes representar√°n a los usuarios en contra y los nodos morados a los usuarios a favor.

Primero, de los tweets de cada comunidad, seleccionaremos solo los tweets cuyos autores y destinatarios pertenezcan a alguna de las comunidades.

```{r}
df_tweets_comunidades <- rbind(df_tweets_favor, df_tweets_vox, df_tweets_terf)
```


Creamos un data frame con las columnas `user_id` y `in_reply_to_user_id` de las comunidades.

```{r}
df_interacciones <- df_tweets_comunidades %>%
  select(user_id, in_reply_to_user_id) %>%
  na.omit()
```

Creamos un grafo general con todas las interacciones. Los nodos tendr√°n un color distinto en funci√≥n de la comunidad a la que pertenezcan. Si no pertenecen a ninguna comunidad se les asignar√° un color gris, si pertenecen a la comunidad a favor se les asignar√° un color rojo, si pertenecen a la comunidad de usuarios de vox se le asignar√° un color verde y si pertenecen a la comunidad de usuarias TERFs se les asignar√° un color morado.

```{r}
grafo_comunidades <- graph_from_data_frame(df_interacciones, directed = TRUE)

# Asignamos un color a cada nodo
V(grafo_comunidades)$color <- ifelse(V(grafo_comunidades)$name %in% df_usuarios_favor$user_id, "red",
                                     ifelse(V(grafo_comunidades)$name %in% df_usuarios_vox$user_id, "green",
                                            ifelse(V(grafo_comunidades)$name %in% df_usuarios_terf$user_id, "purple", "gray")))
```

Por √∫ltimo, mostramos el grafo.

```{r}
plot(
  grafo_comunidades,
  vertex.color = V(grafo_comunidades)$color,
  vertex.size = 5,
  edge.arrow.size = 0.2,
  edge.color = "gray",
  vertex.label = NA,
  main = "Grafo de interacciones de las comunidades"
)

legend("bottomright", legend = c("A favor", "Vox", "TERF", "Neutro"), fill = c("red", "green", "purple", "gray"))
```

Observamos que las comunidades est√°n bastante dispersas, esto se puede deber a que en twitter predomina el "debate" y la interacci√≥n entre usuarios de distintas opiniones. Adem√°s, al ser un tema tan polarizado, es probable que muchos usuarios interact√∫en con usuarios de la opini√≥n contraria. 

Tambi√©n encontramos nodos morados y rojos que atraen a muchos nodos neutros, lo que puede indicar que las usuarias TERFs y los usuarios a favor de la ley tienen una gran influencia en la red.

### 10. Conclusiones <a name="conclusiones"></a>

Este proyecto ha cambiado nuestra percepci√≥n sobre el fen√≥meno de la ley trans en Espa√±a. Incialmente pens√°bamos que predominar√≠an los sentimientos negativos ya que se trata de un tema muy pol√©mico, adem√°s de que la fama de twitter es la de ser una red social en la que se comparten opiniones negativas. Sin embargo, hemos visto que los sentimientos positivos y negativos est√°n bastante equilibrados, ganando los positivos, debido a que en el dataset analizado la ley tiene m√°s apoyo que detractores.

Otro aspecto que nos ha sorprendido es que la mayor√≠a de detractores de la ley son feministas TERF, y no votantes de derechas como pens√°bamos en un principio. Algunos de los tweets que hemos visto de las usuarias TERFs son muy agresivos y radicales, lo cual no nos esper√°bamos de usuarios que comparten espectro pol√≠tico con las personas a favor de la ley.

En general, hemos comprobado de que se trata de un tema muy pasional y polarizado, que aunque en general hay m√°s apoyo que detractores, ambas partes tienen sus ideas muy claras y no est√°n dispuestas a ceder.